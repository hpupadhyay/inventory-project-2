{% extends "inventory/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<h2 class="text-3xl font-bold mb-6">Bill of Materials (BOM)</h2>
{% if messages %}{% for message in messages %}
<div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}" role="alert">{{ message }}</div>
{% endfor %}{% endif %}

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-bold mb-4">Create New BOM</h3>
    <form method="post">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-4">
                <div>{{ form.group }}</div>
                <div>{{ form.item }}</div>
            </div>

            <div class="md:col-span-2">
                <label class="font-medium">Raw Materials</label>
                {{ formset.management_form }}
                <div id="bom-item-list" class="space-y-2 mt-2">
                    {% for item_form in formset %}
                    <div class="flex items-end space-x-2 item-form">
                        <div class="flex-grow">{{ item_form.group }}</div>
                        <div class="flex-grow">{{ item_form.item }}</div>
                        <div class="w-28">{{ item_form.quantity }}</div>
                        <div class="w-24 pb-2"><button type="button" class="remove-bom-item text-red-500 hover:text-red-700 font-bold">Remove</button></div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-bom-item" class="text-sm text-blue-600 hover:text-blue-800 mt-2">+ Add Material</button>
            </div>
        </div>
        <button type="submit" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Save BOM</button>
    </form>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-bold mb-4">Existing BOMs</h3>
    <div class="space-y-4">
        {% for bom in boms %}
        <details class="bg-gray-50 rounded p-3">
            <summary class="font-semibold cursor-pointer">BOM for: {{ bom.item.name }}</summary>
            <ul class="list-disc list-inside mt-2 ml-4 text-sm">
                {% for item in bom.items.all %}
                <li>{{ item.item.name }} - ({{ item.quantity|floatformat:2 }})</li>
                {% endfor %}
            </ul>
        </details>
        {% empty %}
        <p class="text-gray-500">No Bills of Material have been created yet.</p>
        {% endfor %}
    </div>
</div>

<div class="hidden" id="empty-form-template">
    <div class="flex items-end space-x-2 item-form">
        <div class="flex-grow">{{ formset.empty_form.group }}</div>
        <div class="flex-grow">{{ formset.empty_form.item }}</div>
        <div class="w-28">{{ formset.empty_form.quantity }}</div>
        <div class="w-24 pb-2"><button type="button" class="remove-bom-item text-red-500 hover:text-red-700 font-bold">Remove</button></div>
    </div>
</div>

<script>
$(document).ready(function() {
    // --- SCRIPT FOR MAIN FINISHED GOOD SELECTION ---
    function initializeMainSelects() {
        const mainGroupSelect = $('#id_group');
        const mainItemSelect = $('#id_item');
        mainGroupSelect.select2({ theme: "classic", width: '100%' });
        mainItemSelect.select2({ theme: "classic", width: '100%', placeholder: 'Select a group first' });
        mainItemSelect.prop('disabled', true);
        mainGroupSelect.on('change', function() {
            const groupId = $(this).val();
            mainItemSelect.val(null).trigger('change').prop('disabled', !groupId);
            if (groupId) {
                mainItemSelect.select2({
                    theme: "classic", width: '100%',
                    ajax: { url: "{% url 'get_items_api' %}", dataType: 'json', data: (p) => ({ term: p.term, group_id: groupId }), processResults: (d) => ({ results: d.results }) },
                    placeholder: 'Type to search...'
                });
            }
        });
    }

    // --- SCRIPT FOR RAW MATERIALS FORMSET ---
    function initializeFormsetRow(row) {
        $(row).find('select').select2({ theme: "classic", width: '100%' });
        const groupSelect = $(row).find('select[name$="-group"]');
        const itemSelect = $(row).find('select[name$="-item"]');
        itemSelect.select2({ theme: "classic", width: '100%', placeholder: 'Select a group first' });
        itemSelect.prop('disabled', true);
        groupSelect.on('change', function() {
            const groupId = $(this).val();
            itemSelect.val(null).trigger('change').prop('disabled', !groupId);
            if (groupId) {
                itemSelect.select2({
                    theme: "classic", width: '100%',
                    ajax: { url: "{% url 'get_items_api' %}", dataType: 'json', data: (p) => ({ term: p.term, group_id: groupId }), processResults: (d) => ({ results: d.results }) },
                    placeholder: 'Type to search...'
                });
            }
        });
    }

    // --- INITIALIZE PAGE ---
    initializeMainSelects();
    $('#bom-item-list .item-form').each(function() { initializeFormsetRow(this); });

    // --- BUTTON CLICK HANDLERS ---
    $('#add-bom-item').click(function() {
        const totalForms = document.querySelector('input[name="bom_items-TOTAL_FORMS"]');
        const formIndex = parseInt(totalForms.value);
        const emptyFormHtml = $('#empty-form-template').html().replace(/__prefix__/g, formIndex);
        const newRow = $(emptyFormHtml).appendTo('#bom-item-list');
        totalForms.value = formIndex + 1;
        initializeFormsetRow(newRow);
    });

    $('#bom-item-list').on('click', '.remove-bom-item', function() {
        $(this).closest('.item-form').remove();
    });
});
</script>
<script>
{% if messages %}
    {% for message in messages %}
        Toastify({
            text: "{{ message }}",
            duration: 3000,
            close: true,
            gravity: "top", // `top` or `bottom`
            position: "right", // `left`, `center` or `right`
            backgroundColor: "{% if message.tags == 'success' %}#4CAF50{% else %}#F44336{% endif %}", // Green for success, Red for error
            stopOnFocus: true
        }).showToast();
    {% endfor %}
{% endif %}
</script>
{% endblock %}