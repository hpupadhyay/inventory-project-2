{% extends "inventory/base.html" %}

{% block content %}
<h2 class="text-3xl font-bold mb-6">Import Data </h2>
<div id="messages-container" class="mb-4"></div>

<div class="space-y-4">
    <details class="bg-white p-4 rounded-lg shadow">
        <summary class="font-semibold text-lg cursor-pointer">Inward Transactions</summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
            <div>
                <h4 class="font-bold mb-2">Import Inward Data</h4>
                <form class="import-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="import_inward">
                    <div class="space-y-2">
                        <div><label>Upload CSV File</label><input type="file" name="csv_file" accept=".csv" required class="w-full"></div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Import CSV</button>
                    </div>
                </form>
                <form method="post" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" name="action" value="download_inward_template" class="text-blue-500 hover:underline text-sm">Download Template</button>
                </form>
            </div>
        </div>
    </details>

    </div>

<div class="space-y-4">
    <details class="bg-white p-4 rounded-lg shadow">
        <summary class="font-semibold text-lg cursor-pointer">Outward Transactions</summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
			<div>
				<h4 class="font-bold mb-2">Import Outward Data</h4>
                <form class="import-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="import_outward">
                    <div class="space-y-2">
                        <div><label>Upload CSV File</label><input type="file" name="csv_file" accept=".csv" required class="w-full"></div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Import CSV</button>
                    </div>
                </form>
                <form method="post" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" name="action" value="download_outward_template" class="text-blue-500 hover:underline text-sm">Download Template</button>
                </form>
            </div>
        </div>
    </details>

    </div>

<script>
$(document).ready(function() {
    // Attach this function to all forms with the 'import-form' class
    $('.import-form').on('submit', async function(e) {
        e.preventDefault(); // Stop the normal page reload
        
        const messagesContainer = $('#messages-container');
        messagesContainer.html('<p class="p-4 mb-4 text-sm rounded-lg bg-blue-100 text-blue-700">Processing your file...</p>');

        const formData = new FormData(this);
        const csrfToken = $(this).find('input[name="csrfmiddlewaretoken"]').val();

        try {
            const response = await fetch("{% url 'import_page' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            const data = await response.json();

            // Display the message from the server
            let messageClass = data.status === 'success' || data.status === 'complete' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            messagesContainer.html(`<div class="p-4 mb-4 text-sm rounded-lg ${messageClass}">${data.message}</div>`);

            // If the server sent back report data, trigger a download
            if (data.report_data) {
                const blob = new Blob([data.report_data], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = data.filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            }
        } catch (error) {
            messagesContainer.html(`<div class="p-4 mb-4 text-sm rounded-lg bg-red-100 text-red-700">A network error occurred. Please try again.</div>`);
        }
    });
});
</script>
{% endblock %}