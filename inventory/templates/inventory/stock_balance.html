{% extends "inventory/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">Opening Stock</h2>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h3 class="text-xl font-bold mb-4">Add / Update Stock for a Single Item</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        {% if form.non_field_errors %}<div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg">{{ form.non_field_errors }}</div>{% endif %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {{ form|crispy }}
        </div>
        <div class="flex justify-end">
            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Save Stock</button>
        </div>
    </form>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <form method="get" class="flex flex-wrap items-end gap-4">
        <div>
            <label class="block font-medium">Warehouse</label>
            <select name="warehouse_filter" id="warehouse_filter" class="mt-1 border-gray-300 rounded-md">
                <option value="">All Warehouses</option>
                {% for wh in all_warehouses %}<option value="{{ wh.pk }}" {% if wh.pk == warehouse_filter %}selected{% endif %}>{{ wh.name }}</option>{% endfor %}
            </select>
        </div>
        <div>
            <label class="block font-medium">Item Group</label>
            <select name="group_filter" id="group_filter" class="mt-1 border-gray-300 rounded-md">
                <option value="">All Groups</option>
                {% for group in all_groups %}<option value="{{ group.pk }}" {% if group.pk == group_filter %}selected{% endif %}>{{ group.name }}</option>{% endfor %}
            </select>
        </div>
        <button type="submit" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Filter</button>
        <a href="{% url 'opening_stock' %}" class="text-sm">Clear</a>
    </form>
</div>

<div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
    <h3 class="text-xl font-bold mb-4">Current Stock Balances</h3>
    <table class="min-w-full bg-white text-sm">
        <thead class="bg-gray-100">
            <tr>
                <th class="py-2 px-3 border-b text-left">Item Name</th>
                <th class="py-2 px-3 border-b text-left">Warehouse</th>
                <th class="py-2 px-3 border-b text-right">Quantity</th>
				<th class="py-2 px-3 border-b text-left">Actions</th> </tr>
            </tr>
        </thead>
        <tbody>
            {% for stock in stock_data %}
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-3 border-b">{{ stock.item.name }}</td>
                <td class="py-2 px-3 border-b">{{ stock.warehouse.name }}</td>
                <td class="py-2 px-3 border-b text-right">{{ stock.quantity|floatformat:2 }}</td>
				<td class="py-2 px-3 border-b">
                <a href="{% url 'opening_stock_edit' stock.pk %}" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></a>
				<a href="{% url 'opening_stock_delete' stock.pk %}" class="text-red-600 hover:text-red-800 ml-2" title="Delete"><i class="fas fa-trash-alt"></i></a>
				</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="py-4 text-center text-gray-500">No opening stock found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="mt-4 flex justify-between items-center">
        <span class="text-sm text-gray-700">Page {{ stock_data.number }} of {{ stock_data.paginator.num_pages }}.</span>
        <div class="flex space-x-2">
            {% if stock_data.has_previous %}<a href="?page={{ stock_data.previous_page_number }}&warehouse_filter={{ warehouse_filter|default:'' }}&group_filter={{ group_filter|default:'' }}" class="px-3 py-1 border rounded-md text-sm">Previous</a>{% endif %}
            {% if stock_data.has_next %}<a href="?page={{ stock_data.next_page_number }}&warehouse_filter={{ warehouse_filter|default:'' }}&group_filter={{ group_filter|default:'' }}" class="px-3 py-1 border rounded-md text-sm">Next</a>{% endif %}
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Make the form dropdowns searchable
    $('#id_item').select2({ theme: "classic", width: '100%' });
    $('#id_warehouse').select2({ theme: "classic", width: '100%' });
    // Make the filter dropdowns searchable
    $('#warehouse_filter').select2({ theme: "classic", width: 'style' });
    $('#group_filter').select2({ theme: "classic", width: 'style' });
});
</script>
{% endblock %}